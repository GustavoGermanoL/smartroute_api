<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRoute - Editor de Rotas Visual</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        #map { height: 600px; width: 100%; border-radius: 10px; border: 2px solid #dee2e6; }
        .sidebar { height: 600px; overflow-y: auto; }
        .card-entrega { font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .card-entrega:hover { background-color: #e9ecef; transform: translateX(5px); }
        .badge-ordem { font-size: 1.1em; width: 30px; text-align: center; }

        /* --- NOVO CSS PARA AS BOLINHAS NUMERADAS --- */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #0d6efd; /* Cor padr√£o (azul Bootstrap) */
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            /* Borda branca para destacar do mapa */
            border: 2px solid white; 
        }
        /* Cor diferente para quando n√£o est√° roteirizado */
        .marker-pin.pendente { background: #ffc107; color: black; }

        /* O n√∫mero dentro da bolinha */
        .marker-number {
            position: absolute;
            width: 30px;
            height: 30px;
            left: 0;
            top: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(45deg); /* Desvira o n√∫mero */
        }
        /* Ajusta cor do texto para fundo amarelo */
        .marker-pin.pendente .marker-number { color: black; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid py-3">
    <div class="row mb-3">
        <div class="col-md-8 d-flex align-items-center">
            <h3 class="m-0 me-3">üó∫Ô∏è SmartRoute Editor</h3>
            <span class="badge bg-secondary">Total: <span id="total-count">0</span></span>
        </div>
        <div class="col-md-4 text-end">
            <button onclick="recalcularRota()" class="btn btn-success fw-bold shadow-sm">
                <i class="fas fa-route"></i> üöÄ Recalcular Ordem
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body p-1">
                    <div id="map"></div>
                </div>
                <div class="card-footer text-muted small bg-white">
                    üí° <strong>Dica:</strong> Arraste as bolinhas azuis para corrigir a localiza√ß√£o exata da casa. Depois clique em "Recalcular Ordem".
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold py-3">
                   Sequ√™ncia Otimizada
                </div>
                <div class="card-body p-0 sidebar bg-white" id="lista-entregas">
                    <div class="text-center p-4 text-muted">Carregando...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    const API_URL = '/entregas';
    let map;
    let markers = {};
    let entregasData = [];
    let routeLayer;

    function initMap() {
        // Centro inicial (Sorocaba)
        map = L.map('map').setView([-23.5015, -47.4521], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
    }

    async function carregarDados() {
        try {
            const res = await axios.get(API_URL);
            // Ordena: Roteirizados primeiro pela ordem, depois os pendentes pelo ID
            entregasData = res.data.sort((a, b) => {
                if (a.ordemNaRota && b.ordemNaRota) return a.ordemNaRota - b.ordemNaRota;
                if (!a.ordemNaRota && !b.ordemNaRota) return a.id - b.id;
                return a.ordemNaRota ? -1 : 1;
            });
            
            renderizarMapa();
            renderizarLista();
            document.getElementById('total-count').innerText = entregasData.length;
        } catch (error) {
            console.error(error);
            // alert("Erro ao carregar entregas do backend.");
            document.getElementById('lista-entregas').innerHTML = '<div class="alert alert-danger m-2">Erro de conex√£o com o servidor.</div>';
        }
    }

    function renderizarMapa() {
        // Limpa tudo
        for (let id in markers) map.removeLayer(markers[id]);
        markers = {};
        if (routeLayer) map.removeLayer(routeLayer);

        const validPoints = [];

        entregasData.forEach(entrega => {
            if (!entrega.latitude || !entrega.longitude) return;
            validPoints.push([entrega.latitude, entrega.longitude]);

            // --- A M√ÅGICA ACONTECE AQUI: √çcone Personalizado com N√∫mero ---
            const ordemTexto = entrega.ordemNaRota ? entrega.ordemNaRota : '?';
            const classeStatus = entrega.ordemNaRota ? '' : 'pendente'; // Amarelo se n√£o tiver ordem

            // Criamos o HTML da bolinha "na m√£o"
            const iconHtml = `
                <div class="marker-pin ${classeStatus}">
                    <div class="marker-number">${ordemTexto}</div>
                </div>
            `;

            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: iconHtml,
                iconSize: [30, 42],
                iconAnchor: [15, 42], // Ponta do alfinete no ch√£o
                popupAnchor: [0, -35]
            });

            // Cria o marcador usando nosso √≠cone customizado
            const marker = L.marker([entrega.latitude, entrega.longitude], {
                draggable: true,
                icon: customIcon, // <--- Usa o √≠cone novo aqui
                title: `${ordemTexto} - ${entrega.logradouro}`
            }).addTo(map);

            // Pop-up melhorado
            marker.bindPopup(`
                <div class="text-center">
                    <h6 class="fw-bold mb-1">Parada #${ordemTexto}</h6>
                    <p class="mb-1">${entrega.logradouro}, ${entrega.numero}</p>
                    <span class="badge bg-light text-dark border">${entrega.codigoPacote}</span>
                </div>
            `);

            // Evento de arrastar para corrigir
            marker.on('dragend', async function(event) {
                const position = marker.getLatLng();
                // Feedback visual imediato (opcional, muda a opacidade)
                marker.setOpacity(0.5); 

                try {
                    await axios.patch(`${API_URL}/${entrega.id}/coordenada`, {
                        lat: position.lat,
                        lng: position.lng
                    });
                    // Volta opacidade ao normal se salvou
                    marker.setOpacity(1);
                    console.log(`Nova posi√ß√£o salva para ID ${entrega.id}`);
                } catch (err) {
                    alert("Erro ao salvar nova posi√ß√£o no servidor!");
                    marker.setOpacity(1);
                    // Opcional: voltar o pino para a posi√ß√£o original se deu erro
                }
            });

            markers[entrega.id] = marker;
        });

        // Desenha linha reta simples entre os pontos ordenados (feedback visual r√°pido)
        if (validPoints.length > 1) {
             // Filtra s√≥ os que j√° t√™m ordem para desenhar a linha
            const routePoints = entregasData
                .filter(e => e.ordemNaRota && e.latitude)
                .map(e => [e.latitude, e.longitude]);

            if(routePoints.length > 1) {
                routeLayer = L.polyline(routePoints, {
                    color: '#0d6efd',
                    weight: 3,
                    opacity: 0.6,
                    dashArray: '5, 10',
                    smoothFactor: 1
                }).addTo(map);
            }
            
            // Ajusta o zoom para caber todos os pontos
            if (validPoints.length > 0) {
                 map.fitBounds(validPoints, { padding: [50, 50] });
            }
        }
    }

    function renderizarLista() {
        const container = document.getElementById('lista-entregas');
        container.innerHTML = '';

        if (entregasData.length === 0) {
             container.innerHTML = '<div class="text-center p-4 text-muted">Nenhuma entrega encontrada. Fa√ßa upload de um PDF.</div>';
             return;
        }

        entregasData.forEach(entrega => {
            const item = document.createElement('div');
            item.className = 'p-2 border-bottom card-entrega d-flex align-items-center';
            
            const badgeColor = entrega.ordemNaRota ? 'bg-primary' : 'bg-warning text-dark';
            const ordemTexto = entrega.ordemNaRota || '?';

            item.innerHTML = `
                <span class="badge ${badgeColor} me-3 badge-ordem p-2">${ordemTexto}</span>
                <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-bold text-truncate">
                        ${entrega.logradouro}, ${entrega.numero}
                    </div>
                    <div class="small text-muted d-flex justify-content-between">
                        <span>${entrega.bairro || 'Sorocaba'}</span>
                        <span class="badge bg-light text-secondary border">${entrega.status}</span>
                    </div>
                </div>
            `;
            
            // Clique na lista foca no mapa e abre o popup
            item.onclick = () => {
                if (markers[entrega.id]) {
                    map.flyTo(markers[entrega.id].getLatLng(), 17, { duration: 1.5 });
                    markers[entrega.id].openPopup();
                    // Toca um efeito visual no pino (opcional)
                    const iconEl = markers[entrega.id].getElement();
                    if(iconEl) {
                        iconEl.style.transition = 'transform 0.3s';
                        iconEl.style.transform += ' scale(1.3)';
                        setTimeout(() => iconEl.style.transform = iconEl.style.transform.replace(' scale(1.3)', ''), 300);
                    }
                }
            };
            
            container.appendChild(item);
        });
    }

    async function recalcularRota() {
        const btn = document.querySelector('button.btn-success');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Calculando...';
        btn.disabled = true;

        try {
            // 1. Chama o backend para rodar o Jsprit
            await axios.post(`${API_URL}/roteirizar`);
            
            // 2. Recarrega os dados para pegar a nova ordem
            await carregarDados();
            
            // Feedback visual
            alert("‚úÖ Rota recalculada com sucesso! As bolinhas foram reordenadas.");

        } catch (err) {
            console.error(err);
            alert("‚ùå Erro ao roteirizar: " + (err.response?.data || err.message));
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Inicializa√ß√£o
    initMap();
    carregarDados();

    // Recarrega ao focar na janela (√∫til se voc√™ alterou algo em outra aba)
    window.onfocus = carregarDados;
</script>

</body>
</html>